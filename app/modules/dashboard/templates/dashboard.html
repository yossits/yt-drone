{% extends "base.html" %} {% block title %}YT-Drone{%
endblock %} {% block content %}

<div class="grid grid-2">
  <div class="card card-compact">
    <div class="card-header">
      <h3 class="card-title">YT-Drone</h3>
    </div>
    <div class="card-body">
      <p>
        <strong>×—×™×‘×•×¨:</strong>
        <span class="badge badge-success">{{ connection_status }}</span>
      </p>
      <p><strong>×¢×•×¦××ª ××•×ª:</strong> {{ signal_strength }}%</p>
    </div>
  </div>

  <div class="card card-compact" data-ws-topic="system_info">
    <div class="card-header">
      <h3 class="card-title">System Information</h3>
    </div>
    <div class="card-body">
      <div class="form-group">
        <label class="form-label">Operating System:</label>
        <div class="info-box" data-ws-field="os_name">{{ os_name }}</div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Hardware:</label>
        <div class="info-box" data-ws-field="hardware">{{ hardware }}</div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Uptime:</label>
        <div class="info-box" data-ws-field="uptime">{{ uptime }}</div>
      </div>
      
      <div class="form-group">
        <label class="form-label">CPU Temperature:</label>
        <div class="progress-bar-row">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="progress-bar-icon"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/></svg>
          <div class="progress-bar progress-bar-temp" 
               style="--temp-fill: {{ cpu_temp_percent }}%;" 
               data-ws-field="cpu_temp_percent"
               data-ws-field-class="temp_class">
            <div class="progress-bar-mask"></div>
          </div>
          <span class="progress-bar-value" data-ws-field="cpu_temp">{{ cpu_temp }}Â°C</span>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">CPU Usage:</label>
        <div class="progress-bar-row">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="progress-bar-icon"><path d="M12 20v2"/><path d="M12 2v2"/><path d="M17 20v2"/><path d="M17 2v2"/><path d="M2 12h2"/><path d="M2 17h2"/><path d="M2 7h2"/><path d="M20 12h2"/><path d="M20 17h2"/><path d="M20 7h2"/><path d="M7 20v2"/><path d="M7 2v2"/><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="8" y="8" width="8" height="8" rx="1"/></svg>
          <div class="progress-bar progress-bar-cpu" 
               style="--fill-percent: {{ cpu_usage }}%;" 
               data-ws-field="cpu_usage">
            <div class="progress-bar-mask"></div>
          </div>
          <span class="progress-bar-value" data-ws-field="cpu_usage">{{ cpu_usage }}%</span>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">RAM Usage:</label>
        <div class="progress-bar-row">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="progress-bar-icon"><path d="M18 12h2"/><path d="M18 16h2"/><path d="M18 20h2"/><path d="M18 4h2"/><path d="M18 8h2"/><path d="M4 12h2"/><path d="M4 16h2"/><path d="M4 20h2"/><path d="M4 4h2"/><path d="M4 8h2"/><path d="M8 2a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2h-1.5c-.276 0-.494.227-.562.495a2 2 0 0 1-3.876 0C9.994 2.227 9.776 2 9.5 2z"/></svg>
          <div class="progress-bar progress-bar-ram" 
               style="--fill-percent: {{ ram_percent }}%;" 
               data-ws-field="ram_percent">
            <div class="progress-bar-mask"></div>
          </div>
          <span class="progress-bar-value" data-ws-field="ram_used">{{ ram_used }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card card-compact grid-span-2">
    <div class="card-header">
      <h3 class="card-title">Storage</h3>
    </div>
    <div class="card-body">
      <div class="storage-grid-wrapper">
      <!-- Boot Partition -->
      <div class="storage-partition">
        <div class="storage-header">
          <h4 class="storage-title">Boot</h4>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="storage-icon"><line x1="22" x2="2" y1="12" y2="12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/><line x1="6" x2="6.01" y1="16" y2="16"/><line x1="10" x2="10.01" y1="16" y2="16"/></svg>
        </div>
        <div class="storage-info">
          <div class="form-group">
            <label class="form-label">Mount Point:</label>
            <div class="info-box" data-ws-field="storage_boot.mountpoint">{{ storage_boot.mountpoint }}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Total:</label>
            <div class="info-box" data-ws-field="storage_boot.total">{{ storage_boot.total }}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Used:</label>
            <div class="info-box" data-ws-field="storage_boot.used">{{ storage_boot.used }}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Free:</label>
            <div class="info-box" data-ws-field="storage_boot.free">{{ storage_boot.free }}</div>
          </div>
          <div class="form-group">
            <div class="progress-bar progress-bar-storage" 
                 style="--fill-percent: {{ storage_boot.percent }}%;"
                 data-ws-field="storage_boot.percent">
              <div class="progress-bar-mask"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- SD Card (Root) Partition -->
      <div class="storage-partition">
        <div class="storage-header">
          <h4 class="storage-title">SD Card</h4>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="storage-icon"><line x1="22" x2="2" y1="12" y2="12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/><line x1="6" x2="6.01" y1="16" y2="16"/><line x1="10" x2="10.01" y1="16" y2="16"/></svg>
        </div>
        <div class="storage-info">
          <div class="form-group">
            <label class="form-label">Mount Point:</label>
            <div class="info-box" data-ws-field="storage_root.mountpoint">{{ storage_root.mountpoint }}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Total:</label>
            <div class="info-box" data-ws-field="storage_root.total">{{ storage_root.total }}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Used:</label>
            <div class="info-box" data-ws-field="storage_root.used">{{ storage_root.used }}</div>
          </div>
          <div class="form-group">
            <label class="form-label">Free:</label>
            <div class="info-box" data-ws-field="storage_root.free">{{ storage_root.free }}</div>
          </div>
          <div class="form-group">
            <div class="progress-bar progress-bar-storage" 
                 style="--fill-percent: {{ storage_root.percent }}%;"
                 data-ws-field="storage_root.percent">
              <div class="progress-bar-mask"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h3 class="card-title">×–××Ÿ ×˜×™×¡×”</h3>
    </div>
    <div class="card-body">
      <p><strong>×–××Ÿ ×›×•×œ×œ:</strong> {{ flight_time }}</p>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h3 class="card-title">××™×§×•×</h3>
    </div>
    <div class="card-body">
      <p><strong>×’×•×‘×”:</strong> {{ altitude }} ××˜×¨</p>
      <p><strong>××”×™×¨×•×ª:</strong> {{ speed }} m/s</p>
      <p><strong>×œ×•×•×™×™× ×™× GPS:</strong> {{ gps_satellites }}</p>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h3 class="card-title">××™×“×¢ × ×•×¡×£</h3>
    </div>
    <div class="card-body">
      <p>×›××Ÿ ×™×•×¦×’ ××™×“×¢ × ×•×¡×£ ×¢×œ ××¦×‘ ×”×¨×—×¤×Ÿ ×•×”××¢×¨×›×ª ×‘×¢×ª×™×“.</p>
      <p>×›×¨×’×¢ ×–×”×• ×××©×§ UI ×‘×œ×‘×“ ×¢× × ×ª×•× ×™ ×“××•.</p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  // ×™×¦×™×¨×ª WebSocketClient instance ×¢× 3 topics
  const wsClient = new WebSocketClient("/ws/", [
    "static_info",
    "slow_info", 
    "fast_info"
  ]);
  
  // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×©×“×•×ª
  function updateFields(fieldNames, data) {
    fieldNames.forEach(fieldName => {
      if (!data.hasOwnProperty(fieldName)) return;
      
      const value = data[fieldName];
      const elements = document.querySelectorAll(`[data-ws-field="${fieldName}"]`);
      
      elements.forEach(element => {
        // ×¢×“×›×•×Ÿ ×˜×§×¡×˜
        if (element.classList.contains('info-box') || 
            element.classList.contains('progress-bar-value')) {
          if (fieldName === 'cpu_temp') {
            element.textContent = `${value}Â°C`;
          } else if (fieldName === 'cpu_usage') {
            element.textContent = `${value}%`;
          } else {
            element.textContent = value;
          }
        }
        
        // ×¢×“×›×•×Ÿ CSS variables ×¢×‘×•×¨ progress bars
        if (fieldName === 'cpu_temp_percent') {
          const progressBar = element.closest('.progress-bar-temp') || 
                             (element.classList.contains('progress-bar-temp') ? element : null);
          if (progressBar) {
            progressBar.style.setProperty('--temp-fill', `${value}%`);
          }
        }
        
        if (fieldName === 'cpu_usage' || fieldName === 'ram_percent') {
          const progressBar = element.closest('.progress-bar') || 
                             (element.classList.contains('progress-bar') ? element : null);
          if (progressBar) {
            progressBar.style.setProperty('--fill-percent', `${value}%`);
          }
        }
        
        // ×¢×“×›×•×Ÿ CSS variable ×¢×‘×•×¨ storage percent
        if (fieldName.includes('storage_') && fieldName.includes('.percent')) {
          const progressBar = element.closest('.progress-bar-storage') || 
                             (element.classList.contains('progress-bar-storage') ? element : null);
          if (progressBar) {
            progressBar.style.setProperty('--fill-percent', `${value}%`);
          }
        }
        
        // ×¢×“×›×•×Ÿ classes ×¢×‘×•×¨ temp_class
        if (fieldName === 'temp_class') {
          const classElement = element.closest('[data-ws-field-class="temp_class"]') || 
                              (element.hasAttribute('data-ws-field-class') && 
                               element.getAttribute('data-ws-field-class') === 'temp_class' ? element : null);
          if (classElement) {
            // ×”×¡×¨×ª ×›×œ ×”-classes ×”×™×©× ×™×
            classElement.classList.remove('progress-bar-temp-cold', 'progress-bar-temp-normal',
                                        'progress-bar-temp-warm', 'progress-bar-temp-hot');
            // ×”×•×¡×¤×ª class ×—×“×©
            classElement.classList.add(`progress-bar-temp-${value}`);
          }
        }
      });
    });
  }
  
  // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×©×“×•×ª Storage
  function updateStorageFields(prefix, storageData) {
    if (!storageData) return;
    
    // ×¢×“×›×•×Ÿ ×›×œ ×”×©×“×•×ª ×©×œ storage
    Object.keys(storageData).forEach(key => {
      const fieldName = `storage_${prefix}.${key}`;
      const value = storageData[key];
      
      const elements = document.querySelectorAll(`[data-ws-field="${fieldName}"]`);
      elements.forEach(element => {
        if (key === 'percent') {
          // ×¢×“×›×•×Ÿ progress bar
          const progressBar = element.closest('.progress-bar-storage') || 
                             (element.classList.contains('progress-bar-storage') ? element : null);
          if (progressBar) {
            progressBar.style.setProperty('--fill-percent', `${value}%`);
          }
          // ×¢×“×›×•×Ÿ ×˜×§×¡×˜ ×©×œ ×”××—×•×–
          if (element.tagName === 'SPAN') {
            element.textContent = value;
          }
        } else {
          // ×¢×“×›×•×Ÿ ×˜×§×¡×˜ ×¨×’×™×œ
          element.textContent = value;
        }
      });
    });
  }
  
  // ×”×’×“×¨×ª handlers
  wsClient.onConnect(function() {
    console.log("WebSocket connected to system monitors");
  });
  
  wsClient.onDisconnect(function() {
    console.log("WebSocket disconnected from system monitors");
  });
  
  // Custom message handler ×¢× switch ×œ×¤×™ topic
  wsClient.onMessage(function(message) {
    if (!message.topic || !message.data) {
      console.log("Received message:", message);
      return;
    }
    
    const topic = message.topic;
    const data = message.data;
    const timestamp = new Date().toLocaleTimeString();
    
    // Switch ×œ×¤×™ topic - ××¢×“×›×Ÿ ×¨×§ ××ª ×”×‘×¨×™× ×”×¨×œ×•×•× ×˜×™×™×
    switch(topic) {
      case 'static_info':
        console.log(`[${timestamp}] ğŸ“Œ STATIC_INFO - Updating static fields:`, {
          os_name: data.os_name,
          hardware: data.hardware,
          ram_total: data.ram_total
        });
        // ×¢×“×›×•×Ÿ ×©×“×•×ª ×¡×˜×˜×™×™× (×¨×§ ×¤×¢× ××—×ª)
        updateFields(['os_name', 'hardware', 'ram_total'], data);
        break;
        
      case 'slow_info':
        console.log(`[${timestamp}] ğŸŒ SLOW_INFO - Updating slow fields:`, {
          uptime: data.uptime,
          storage_boot: data.storage_boot,
          storage_root: data.storage_root
        });
        // ×¢×“×›×•×Ÿ ×©×“×•×ª ××™×˜×™×™× (×›×œ 60 ×©× ×™×•×ª)
        updateFields(['uptime'], data);
        
        // ×¢×“×›×•×Ÿ Storage (×× ×§×™×™×)
        if (data.storage_boot) {
          updateStorageFields('boot', data.storage_boot);
        }
        if (data.storage_root) {
          updateStorageFields('root', data.storage_root);
        }
        break;
        
      case 'fast_info':
        console.log(`[${timestamp}] âš¡ FAST_INFO - Updating fast fields:`, {
          cpu_temp: data.cpu_temp,
          cpu_temp_percent: data.cpu_temp_percent,
          temp_class: data.temp_class,
          cpu_usage: data.cpu_usage,
          ram_used: data.ram_used,
          ram_percent: data.ram_percent
        });
        // ×¢×“×›×•×Ÿ ×©×“×•×ª ××”×™×¨×™× (×›×œ 5 ×©× ×™×•×ª)
        updateFields(['cpu_temp', 'cpu_temp_percent', 'temp_class', 
                     'cpu_usage', 'ram_used', 'ram_percent'], data);
        break;
        
      default:
        console.log(`[${timestamp}] â“ Unknown topic:`, topic, message);
    }
  });
  
  // ×—×™×‘×•×¨ ×œ-WebSocket
  wsClient.connect();
  
  // ×©××™×¨×ª instance ×’×œ×•×‘×œ×™ (×œ××§×¨×” ×©×œ ×¦×•×¨×š ×‘×¢×“×›×•×Ÿ ×™×“× ×™)
  window.dashboardWSClient = wsClient;
});
</script>
{% endblock %}
